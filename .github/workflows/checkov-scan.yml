name: Checkov Scan (Reusable)

on:
  workflow_call:
    inputs:
      output_format:
        description: 'Output format for Checkov results (e.g., cli or cli,sarif)'
        required: false
        type: string
        default: 'cli'
      output_file_path:
        description: 'Output file path for Checkov results (e.g., console or console,results.sarif)'
        required: false
        type: string
        default: 'console'
      upload_sarif:
        description: 'Enable or disable SARIF file upload (true/false)'
        required: false
        type: boolean
        default: false
      path_to_check:
        description: 'File or directory path to monitor for changes (e.g., infrastructure/**)'
        required: false
        type: string
        default: '**'

jobs:
  scan:
    permissions:
      contents: read
      actions: read
      security-events: write

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 2 # Fetch enough history to compare changes

      - name: Check if specified path has changed
        id: check-path
        run: |
          if [[ "${{ inputs.path_to_check }}" == "**" ]]; then
            echo "Path is set to all files, proceeding with scan."
            echo "path_changed=true" >> $GITHUB_OUTPUT
          else
            # Check if any files in the specified path have changed
            git diff --name-only HEAD^ HEAD | grep -E "${{ inputs.path_to_check }}" > /dev/null
            if [ $? -eq 0 ]; then
              echo "Changes detected in ${{ inputs.path_to_check }}."
              echo "path_changed=true" >> $GITHUB_OUTPUT
            else
              echo "No changes detected in ${{ inputs.path_to_check }}."
              echo "path_changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Checkov GitHub Action
        if: steps.check-path.outputs.path_changed == 'true'
        uses: bridgecrewio/checkov-action@99bb2caf247dfd9f03cf984373bc6043d4e32ebf # v12.1347.0
        with:
          output_format: ${{ inputs.output_format }}
          output_file_path: ${{ inputs.output_file_path }}
          framework: terraform # Explicitly set to terraform framework
