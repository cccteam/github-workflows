# This Continuous Integration (CI) workflow template can be used in repositories that contain Terraform code.
#
# The following jobs are included:
#  * terraform-docs: Formats Terraform files, generates documentation, and pushes changes
#  * tflint: Runs TFLint on changed Terraform files
#  * checkov-scan: Runs Checkov security scanning on changed Terraform files
#
# NOTE: Certain inputs are required, as detailed in the "inputs" section below.

name: Terraform CI (Reusable)

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      working_dirs:
        description: '(Deprecated) Comma-separated list of directories containing Terraform configs. Now auto-detected from changed files.'
        required: false
        type: string
        default: ''
      output_file:
        description: Output file for generated docs
        required: false
        type: string
        default: README.md
      output_method:
        description: Method to apply the generated docs (e.g., replace, inject)
        required: false
        type: string
        default: replace
      git_push:
        description: Whether to push changes back to the PR
        required: false
        type: boolean
        default: true
      terraform_version:
        description: 'Terraform version to use'
        required: false
        type: string
        default: '1.13.1'
      output_format:
        description: 'Output format for Checkov results (e.g., cli or cli,sarif)'
        required: false
        type: string
        default: 'cli'
      output_file_path:
        description: 'Output file path for Checkov results (e.g., console or console,results.sarif)'
        required: false
        type: string
        default: 'console'
      upload_sarif:
        description: 'Enable or disable SARIF file upload for Checkov and TFLint (true/false)'
        required: false
        type: boolean
        default: false
      skip_check:
        description: 'Comma-separated list of checks to skip (e.g., CKV_TF_1,CKV_GCP_18)'
        required: false
        type: string
        default: ''
    secrets:
      app_id:
        description: GitHub App ID for authentication
        required: true
      app_pem:
        description: GitHub App private key for authentication
        required: true

jobs:
  terraform-docs:
    name: Format and document Terraform
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Check for Terraform file changes
        id: check-changes
        run: |
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRTUXB origin/${{ github.base_ref }}...HEAD | grep -E '\.tf$|\.tfvars$' || true)
          if [ -z "$CHANGED_FILES" ]; then
            echo "No .tf or .tfvars files changed. Skipping terraform-docs."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: No Terraform changes detected
        if: steps.check-changes.outputs.has_changes != 'true'
        run: |
          echo "No Terraform files changed. Passing check."
          exit 0

      - name: Generate GitHub App Token
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.app_id }}
          private-key: ${{ secrets.app_pem }}

      - uses: actions/checkout@v5
        if: steps.check-changes.outputs.has_changes == 'true'
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Warn about deprecated working_dirs input
        if: steps.check-changes.outputs.has_changes == 'true' && inputs.working_dirs != ''
        run: |
          echo "⚠️  WARNING: The 'working_dirs' input is deprecated and no longer used."
          echo "The workflow now automatically detects changed Terraform directories."
          echo "You can safely remove 'working_dirs' from your workflow configuration."

      - name: Set up Terraform
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Find changed Terraform directories
        if: steps.check-changes.outputs.has_changes == 'true'
        id: changed-files
        run: |
          # Get changed .tf and .tfvars files
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRTUXB origin/${{ github.base_ref }}...HEAD | grep -E '\.tf$|\.tfvars$' || true)
          if [ -z "$CHANGED_FILES" ]; then
            echo "No .tf or .tfvars files changed. Skipping format check."
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "dirs=" >> $GITHUB_OUTPUT
          else
            # Get unique directories of changed files
            CHANGED_DIRS=$(echo "$CHANGED_FILES" | xargs -n 1 dirname | sort -u | tr '\n' ' ' | sed 's/ $//')
            echo "Changed Terraform directories: $CHANGED_DIRS"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "dirs=$CHANGED_DIRS" >> $GITHUB_OUTPUT
          fi

      - name: Format Terraform files
        if: steps.check-changes.outputs.has_changes == 'true' && steps.changed-files.outputs.changed == 'true'
        run: |
          #!/bin/bash
          set -e
          if ! command -v terraform &> /dev/null; then
            echo "Error: Terraform is not installed."
            exit 1
          fi
          DIRS="${{ steps.changed-files.outputs.dirs }}"
          if [ -z "$DIRS" ]; then
            echo "No directories to check. Skipping."
            exit 0
          fi
          IFS=' ' read -ra DIR_ARRAY <<< "$DIRS"
          for DIR in "${DIR_ARRAY[@]}"; do
            if [ -d "$DIR" ]; then
              echo "Formatting Terraform files in $DIR..."
              terraform fmt -recursive "$DIR"
            fi
          done
          echo "Terraform files formatted."

      - name: Commit and push formatted files
        if: steps.check-changes.outputs.has_changes == 'true' && steps.changed-files.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Auto-format Terraform files" || echo "No changes to commit"
          git push

      - name: Render Terraform docs and push changes
        if: steps.check-changes.outputs.has_changes == 'true' && steps.changed-files.outputs.changed == 'true'
        uses: terraform-docs/gh-actions@v1.4.1
        with:
          working-dir: ${{ steps.changed-files.outputs.dirs }}
          output-file: ${{ inputs.output_file }}
          output-method: ${{ inputs.output_method }}
          git-push: ${{ inputs.git_push }}
          git-push-user-name: github-actions[bot]
          git-push-user-email: github-actions[bot]@users.noreply.github.com
          git-push-token: ${{ steps.app-token.outputs.token }}

  detect-changed-dirs:
    name: Detect Changed Terraform Directories
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      dirs: ${{ steps.detect.outputs.dirs }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect changed directories
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD | grep -E '\.tf$|\.tfvars$' || true)
          else
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR HEAD^ HEAD | grep -E '\.tf$|\.tfvars$' || true)
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "dirs=[]" >> $GITHUB_OUTPUT
          else
            # Get unique directories of changed files
            CHANGED_DIRS=$(echo "$CHANGED_FILES" | xargs -n 1 dirname | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "dirs=$CHANGED_DIRS" >> $GITHUB_OUTPUT
            echo "Changed directories: $CHANGED_DIRS"
          fi

  tflint:
    name: Run TFLint on Changed Files
    runs-on: ubuntu-latest
    needs: [terraform-docs, detect-changed-dirs]
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: No Terraform changes detected
        if: needs.detect-changed-dirs.outputs.has_changes != 'true'
        run: |
          echo "No Terraform files changed. Skipping TFLint."
          exit 0

      - name: Checkout code
        if: needs.detect-changed-dirs.outputs.has_changes == 'true'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up TFLint
        if: needs.detect-changed-dirs.outputs.has_changes == 'true'
        uses: terraform-linters/setup-tflint@v6.2.1
        with:
          tflint_version: latest

      - name: Run TFLint on all changed directories
        if: needs.detect-changed-dirs.outputs.has_changes == 'true'
        run: |
          #!/bin/bash
          set -e
          DIRS='${{ needs.detect-changed-dirs.outputs.dirs }}'
          UPLOAD_SARIF='${{ inputs.upload_sarif }}'

          if [ "$UPLOAD_SARIF" = "true" ]; then
            mkdir -p /tmp/sarif
          fi

          echo "$DIRS" | jq -r '.[]' | while read DIR; do
            if [ -z "$DIR" ]; then
              continue
            fi
            echo "Running TFLint in $DIR..."
            cd "$GITHUB_WORKSPACE/$DIR"
            tflint --init
            if [ "$UPLOAD_SARIF" = "true" ]; then
              tflint --format=sarif --minimum-failure-severity=error > /tmp/sarif/tflint-${DIR//\//-}.sarif || true
            else
              tflint --minimum-failure-severity=error
            fi
          done

      - name: Upload TFLint SARIF file
        if: needs.detect-changed-dirs.outputs.has_changes == 'true' && inputs.upload_sarif == true && hashFiles('/tmp/sarif/tflint-*.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: /tmp/sarif/tflint-*.sarif
          category: tflint
          wait-for-processing: true

  checkov-scan:
    name: Run Checkov Scan on Changed Files
    runs-on: ubuntu-latest
    needs: [terraform-docs, detect-changed-dirs]
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Identify changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD > changed_files.txt || true
          else
            git diff --name-only --diff-filter=ACMR HEAD^ HEAD > changed_files.txt || true
          fi
          if [ -s changed_files.txt ]; then
            CHANGED_FILES=$(paste -sd ' ' changed_files.txt)
            echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkov GitHub Action
        if: steps.changed-files.outputs.has_files == 'true'
        uses: bridgecrewio/checkov-action@v12
        with:
          file: ${{ steps.changed-files.outputs.files }}
          output_format: ${{ inputs.output_format }}
          output_file_path: ${{ inputs.output_file_path }}
          quiet: true
          skip_check: ${{ inputs.skip_check }}

      - name: Upload SARIF file
        if: inputs.upload_sarif == true && steps.changed-files.outputs.has_files == 'true' && hashFiles('results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
          category: checkov
